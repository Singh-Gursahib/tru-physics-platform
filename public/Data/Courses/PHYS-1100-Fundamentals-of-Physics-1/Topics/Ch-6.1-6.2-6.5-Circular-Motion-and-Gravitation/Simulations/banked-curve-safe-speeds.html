<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PHYS1100 | Banked Curve with Friction: Safe Speeds & FBD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- Tailwind CSS via CDN (for layout & light theme) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sidebar-bg: #064e3b;
      --sidebar-bg-soft: #065f46;
      --accent-teal: #22c55e;
      --accent-teal-soft: #4ade80;
      --accent-blue: #38bdf8;
      --accent-magenta: #a855f7;
      --accent-amber: #f59e0b;
      --accent-red: #ef4444;
      --accent-gray: #111827;
      --road-gray: #6b7280;
      --bg-soft: #f3f4f6;
      --bg-canvas: #e5e7eb;
      --text-soft: #9ca3af;
      --text-light: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, -sans-serif;
      background:
        radial-gradient(circle at top left, #eff6ff 0, #e0f7f5 26%, #f9fafb 68%, #eef2ff 100%);
      color: #111827;
      overflow: hidden;
    }

    .layout-root {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 0;
      width: 100vw;
      height: 100vh;
    }

    /* LEFT: Dark teal control panel */
    .sidebar {
      background: radial-gradient(circle at top left, #047857, #064e3b 36%, #022c22 100%);
      padding: 1.1rem 1rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      color: var(--text-light);
      box-shadow: 4px 0 18px rgba(15, 23, 42, 0.4);
      z-index: 5;
    }

    .sidebar-header-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.18rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 253, 0.45);
      background: rgba(15, 23, 42, 0.92);
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--accent-teal-soft);
    }

    .sidebar-header-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-teal);
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.9);
    }

    .sidebar-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: #bbf7d0;
      letter-spacing: 0.01em;
      margin-top: 0.05rem;
    }

    .sidebar-subtitle {
      font-size: 0.72rem;
      color: #a7f3d0;
      line-height: 1.45;
    }

    .control-label {
      font-size: 0.7rem;
      font-weight: 500;
      color: #d1fae5;
      margin-bottom: 0.08rem;
    }

    .control-sub {
      font-size: 0.6rem;
      color: #6ee7b7;
      margin-bottom: 0.12rem;
    }

    .control-value {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-teal-soft);
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas;
    }

    .slider-wrap {
      margin-bottom: 0.4rem;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      outline: none;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 253, 0.3);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #16a34a);
      box-shadow:
        0 0 0 2px #022c22,
        0 2px 8px rgba(15, 23, 42, 0.8);
      transition: all 0.16s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.06) translateY(-0.5px);
      box-shadow:
        0 0 0 2px #065f46,
        0 4px 14px rgba(15, 23, 42, 1);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.1rem;
    }

    .btn {
      border-radius: 999px;
      padding: 0.28rem 0.9rem;
      border: none;
      font-size: 0.7rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.18s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.85);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.98);
      color: #a7f3d0;
      border: 1px solid rgba(148, 163, 253, 0.6);
    }

    .btn-ghost:hover {
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .legend-text {
      font-size: 0.58rem;
      color: #9ca3af;
      margin-top: 0.12rem;
    }

    .legend-key {
      padding: 0.12rem 0.4rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 253, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      font-size: 0.58rem;
      color: #9ca3af;
    }

    .legend-key span.key {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(148, 163, 253, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      color: #9ca3af;
    }

    /* RIGHT: Visualization area */
    .main {
      padding: 1rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      background: var(--bg-soft);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .main-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .main-subtitle {
      font-size: 0.7rem;
      color: #6b7280;
      max-width: 540px;
    }

    .right-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.6rem;
      color: #6b7280;
    }

    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      margin-right: 0.18rem;
    }

    .canvas-wrapper {
      flex: 1;
      background: #e5e7eb;
      border-radius: 1.1rem;
      padding: 0.6rem 0.7rem;
      box-shadow:
        0 14px 30px rgba(148, 163, 253, 0.24),
        0 0 22px rgba(148, 163, 253, 0.18);
      border: 1px solid rgba(148, 163, 253, 0.26);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .canvas-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.64rem;
      color: #4b5563;
      flex-wrap: wrap;
    }

    .pill-soft {
      padding: 0.16rem 0.5rem;
      border-radius: 999px;
      background: rgba(243, 244, 246, 0.98);
      border: 1px solid rgba(148, 163, 253, 0.45);
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      font-size: 0.6rem;
    }

    #p5-root {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @media (max-width: 1000px) {
      body {
        overflow-y: auto;
      }
      .layout-root {
        grid-template-columns: 1fr;
        height: auto;
      }
      .sidebar {
        height: auto;
      }
      .main {
        height: 640px;
      }
    }
  </style>
</head>
<body>
<div class="layout-root">
  <!-- LEFT SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header-pill">
      <span class="dot"></span>
      PHYS1100 · Ch 6: Banked Curves with Friction
    </div>
    <div class="sidebar-title">Safe Speeds on a Banked Curve</div>
    <div class="sidebar-subtitle">
      Adjust the bank angle, friction, radius, and car speed. The animation shows a car on a circular banked
      track and a live Free Body Diagram. If v is outside the safe range, the car drifts up or down the bank.
    </div>

    <!-- Sliders -->
    <div class="slider-wrap">
      <div class="control-label">Bank Angle β</div>
      <div class="control-sub">Tilt of the road surface</div>
      <div class="control-value" id="beta-value">25.0°</div>
      <input id="beta-slider" type="range" min="5" max="40" step="0.5" value="25" />
    </div>

    <div class="slider-wrap">
      <div class="control-label">Curve Radius R</div>
      <div class="control-sub">Measured to car path</div>
      <div class="control-value" id="R-value">50 m</div>
      <input id="R-slider" type="range" min="20" max="150" step="5" value="50" />
    </div>

    <div class="slider-wrap">
      <div class="control-label">Static Friction μₛ</div>
      <div class="control-sub">Wet road: ~0.30</div>
      <div class="control-value" id="mu-value">0.30</div>
      <input id="mu-slider" type="range" min="0" max="0.6" step="0.02" value="0.30" />
    </div>

    <div class="slider-wrap">
      <div class="control-label">Car Speed v</div>
      <div class="control-sub">Test speed vs. safe range</div>
      <div class="control-value" id="v-value">18.0 m/s</div>
      <input id="v-slider" type="range" min="0" max="40" step="0.5" value="18" />
    </div>

    <!-- Buttons -->
    <div class="btn-row">
      <button id="reset-btn" class="btn btn-ghost">Reset to Problem Values</button>
      <button id="snap-safe-btn" class="btn btn-primary">Snap to Safe Speed</button>
    </div>
    <div class="btn-row">
      <div class="legend-key">
        <span class="key">Space</span> Pause / Play
      </div>
      <div class="legend-key">
        <span class="key">←</span><span class="key">→</span> Adjust v
      </div>
      <div id="toggle-fbd-btn" class="legend-key" style="cursor:pointer;">
        Toggle FBD
      </div>
    </div>

    <!-- Text legend -->
    <div class="legend-text">
      Status color:
      <span style="color:#22c55e;">No Slip</span>,
      <span style="color:#f97316;">Sliding Down</span>,
      <span style="color:#ef4444;">Sliding Up</span>.
      The car's radial drift on the track matches this classification.
    </div>
  </aside>

  <!-- RIGHT MAIN AREA -->
  <section class="main">
    <div class="top-bar">
      <div>
        <div class="main-title">Frictional Banked Curve — Safe Speed Band and Drift Visualization</div>
        <div class="main-subtitle">
          The car travels on a circular banked track. Using the FBD conditions for impending up/down slip,
          the simulation computes v_min and v_max. If v is below v_min, friction is up the slope and the car
          drifts inward; if v is above v_max, friction is down the slope and the car drifts outward.
        </div>
      </div>
      <div class="right-legend">
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#22c55e;"></span><span>Safe (No Slip)</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#f97316;"></span><span>Sliding Down</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#ef4444;"></span><span>Sliding Up</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#3b82f6;"></span><span>mg</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#111827;"></span><span>N</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="legend-dot" style="background:#22c55e;"></span><span>fₛ</span>
        </div>
      </div>
    </div>

    <div class="canvas-wrapper">
      <div class="canvas-toolbar">
        <div class="flex flex-wrap items-center gap-2">
          <div class="pill-soft">
            β = <span id="beta-label" class="font-mono text-emerald-700">25.0°</span>
          </div>
          <div class="pill-soft">
            μₛ = <span id="mu-label" class="font-mono text-emerald-700">0.30</span>
          </div>
          <div class="pill-soft">
            R = <span id="R-label" class="font-mono text-slate-800">50</span> m
          </div>
          <div class="pill-soft">
            v_min = <span id="vmin-label" class="font-mono text-sky-700">-</span> m/s
          </div>
          <div class="pill-soft">
            v_max = <span id="vmax-label" class="font-mono text-sky-700">-</span> m/s
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <div class="pill-soft">
            v = <span id="v-label-top" class="font-mono">18.0</span> m/s
          </div>
          <div class="pill-soft">
            Status: <span id="status-label" class="font-semibold text-emerald-600">No Slip</span>
          </div>
          <div class="pill-soft">
            Required a_c = <span id="ac-label" class="font-mono text-fuchsia-700">-</span> m/s²
          </div>
        </div>
      </div>
      <div id="p5-root"></div>
    </div>
  </section>
</div>

<script>
  // New, clean implementation of the banked curve simulation.
  // Two-panel design:
  //  - Left: controls and formulas.
  //  - Right: top-down view of a circular banked track + mini FBD.
  // Car drifts radially inward/outward based on v relative to (v_min, v_max).

  const sketch = (p) => {
    const CANVAS_W = 900;
    const CANVAS_H = 430;

    // Track geometry
    const centerX = 430;
    const centerY = 285;
    const baseR = 120;         // visual radius corresponding roughly to R slider
    const trackWidth = 38;

    // FBD mini panel
    const fbdX = 720;
    const fbdY = 70;
    const fbdW = 150;
    const fbdH = 150;

    // Physics parameters (defaults)
    let betaDeg = 25.0;
    let mu = 0.30;
    let R = 50.0;     // m
    const g = 9.8;
    let v = 18.0;     // m/s

    // Derived
    let vMin = null;
    let vMax = null;
    let status = "No Slip";
    let statusColor = "#22c55e";
    let ac = 0;

    // Animation / car state
    let t = 0;
    let running = true;
    let showFBD = true;
    let theta = 0;         // angular position along track
    let rOffset = 0;       // radial offset from baseR; positive outward

    // DOM references
    let betaSlider, muSlider, RSlider, vSlider;
    let betaValue, muValue, RValue, vValue;
    let betaLabel, muLabel, RLabel, vLabelTop;
    let vminLabel, vmaxLabel, statusLabel, acLabel;
    let resetBtn, snapSafeBtn, toggleFbdBtn;

    p.setup = () => {
      const canvas = p.createCanvas(CANVAS_W, CANVAS_H);
      canvas.parent("p5-root");
      p.frameRate(60);
      linkDOM();
      applyAll();
    };

    function linkDOM() {
      betaSlider = p.select("#beta-slider");
      muSlider = p.select("#mu-slider");
      RSlider = p.select("#R-slider");
      vSlider = p.select("#v-slider");

      betaValue = p.select("#beta-value");
      muValue = p.select("#mu-value");
      RValue = p.select("#R-value");
      vValue = p.select("#v-value");

      betaLabel = p.select("#beta-label");
      muLabel = p.select("#mu-label");
      RLabel = p.select("#R-label");
      vLabelTop = p.select("#v-label-top");

      vminLabel = p.select("#vmin-label");
      vmaxLabel = p.select("#vmax-label");
      statusLabel = p.select("#status-label");
      acLabel = p.select("#ac-label");

      resetBtn = p.select("#reset-btn");
      snapSafeBtn = p.select("#snap-safe-btn");
      toggleFbdBtn = p.select("#toggle-fbd-btn");

      betaSlider.input(() => {
        betaDeg = parseFloat(betaSlider.value());
        applyAll();
      });
      muSlider.input(() => {
        mu = parseFloat(muSlider.value());
        applyAll();
      });
      RSlider.input(() => {
        R = parseFloat(RSlider.value());
        applyAll();
      });
      vSlider.input(() => {
        v = parseFloat(vSlider.value());
        applySpeed();
      });

      resetBtn.mousePressed(resetDefaults);
      snapSafeBtn.mousePressed(snapToSafe);
      toggleFbdBtn.mousePressed(() => {
        showFBD = !showFBD;
      });
    }

    function resetDefaults() {
      betaDeg = 25.0;
      mu = 0.30;
      R = 50.0;
      v = 18.0;

      betaSlider.value(betaDeg);
      muSlider.value(mu);
      RSlider.value(R);
      vSlider.value(v);

      applyAll();
    }

    function snapToSafe() {
      computeLimits();
      if (vMin !== null && vMax !== null && vMax > vMin) {
        v = 0.5 * (vMin + vMax);
      } else if (vMin !== null && (vMax === null || vMax <= 0)) {
        v = vMin * 1.05;
      } else if (vMax !== null && (vMin === null || vMin <= 0)) {
        v = vMax * 0.95;
      } else {
        v = 0;
      }
      v = Math.max(0, Math.min(v, parseFloat(vSlider.elt.max)));
      vSlider.value(v);
      applySpeed();
    }

    function applyAll() {
      // Sync labels
      betaValue.html(betaDeg.toFixed(1) + "°");
      muValue.html(mu.toFixed(2));
      RValue.html(R.toFixed(0) + " m");

      betaLabel.html(betaDeg.toFixed(1) + "°");
      muLabel.html(mu.toFixed(2));
      RLabel.html(R.toFixed(0));

      computeLimits();
      applySpeed();
    }

    function applySpeed() {
      vValue.html(v.toFixed(1) + " m/s");
      vLabelTop.html(v.toFixed(1));
      computeStatus();
    }

    function computeLimits() {
      const beta = (betaDeg * Math.PI) / 180;
      const s = Math.sin(beta);
      const c = Math.cos(beta);

      vMin = null;
      vMax = null;

      // v_max (slide up: friction down-slope)
      const denomMax = c - mu * s;
      const numerMax = s + mu * c;
      if (denomMax > 0 && numerMax > 0) {
        const v2 = (R * g * numerMax) / denomMax;
        if (v2 > 0) vMax = Math.sqrt(v2);
      }

      // v_min (slide down: friction up-slope)
      const denomMin = c + mu * s;
      const numerMin = s - mu * c;
      if (denomMin > 0 && numerMin > 0) {
        const v2 = (R * g * numerMin) / denomMin;
        if (v2 > 0) vMin = Math.sqrt(v2);
      }

      vminLabel.html(vMin !== null ? vMin.toFixed(2) : "N/A");
      vmaxLabel.html(vMax !== null ? vMax.toFixed(2) : "N/A");
    }

    function computeStatus() {
      ac = v > 0 && R > 0 ? (v * v) / R : 0;
      acLabel.html(ac.toFixed(2));

      let s = "No Slip";
      let col = "#22c55e";

      if (vMin !== null && vMax !== null && vMax > vMin) {
        if (v < vMin - 1e-4) {
          s = "Sliding Down (too slow)";
          col = "#f97316";
        } else if (v > vMax + 1e-4) {
          s = "Sliding Up (too fast)";
          col = "#ef4444";
        }
      } else if (vMax !== null && (vMin === null || vMin <= 0)) {
        if (v > vMax + 1e-4) {
          s = "Sliding Up (too fast)";
          col = "#ef4444";
        }
      } else if (vMin !== null && (vMax === null || vMax <= 0)) {
        if (v < vMin - 1e-4) {
          s = "Sliding Down (too slow)";
          col = "#f97316";
        }
      }

      status = s;
      statusColor = col;
      statusLabel.html(s);
      statusLabel.elt.style.color = col;
    }

    // Determine qualitative drift direction for animation based on status
    function getDriftDirection() {
      if (status.startsWith("Sliding Up")) return +1;    // outward
      if (status.startsWith("Sliding Down")) return -1;  // inward
      return 0;
    }

    p.draw = () => {
      p.clear();
      p.background(0, 0, 0, 0);

      if (running) {
        t += 0.02;
        theta = (theta + (v / 80)) % (2 * Math.PI);
        // Smooth radial drift based on status
        const drift = getDriftDirection();
        rOffset += drift * 0.3;
        // Clamp radial offset so car stays on screen
        rOffset = p.constrain(rOffset, -18, 18);
      }

      drawScene();
      if (showFBD) drawFBDPanel();
    };

    function drawScene() {
      // Grass background
      p.push();
      p.noStroke();
      p.fill(148, 227, 120);
      p.rect(0, CANVAS_H * 0.35, CANVAS_W, CANVAS_H * 0.65);
      p.pop();

      // Track (two concentric ellipses approximating a 3D look)
      const beta = (betaDeg * Math.PI) / 180;

      p.push();
      p.translate(centerX, centerY);

      // Outer track
      p.fill(120);
      p.noStroke();
      p.ellipse(0, 0, 2 * (baseR + trackWidth), 2 * (baseR + trackWidth) * 0.6);

      // Inner grass
      p.fill(148, 227, 120);
      p.ellipse(0, 0, 2 * (baseR - trackWidth), 2 * (baseR - trackWidth) * 0.6);

      // Lane center line
      p.stroke(234, 179, 8);
      p.strokeWeight(3);
      const steps = 48;
      for (let i = 0; i < steps; i += 2) {
        const a1 = (i / steps) * 2 * Math.PI;
        const a2 = ((i + 1) / steps) * 2 * Math.PI;
        const rMid = baseR;
        const x1 = rMid * Math.cos(a1);
        const y1 = 0.6 * rMid * Math.sin(a1);
        const x2 = rMid * Math.cos(a2);
        const y2 = 0.6 * rMid * Math.sin(a2);
        p.line(x1, y1, x2, y2);
      }

      // Radius arrow to car (later)

      p.pop();

      drawCar();
    }

    function drawCar() {
      const drift = getDriftDirection();
      const beta = (betaDeg * Math.PI) / 180;

      const effectiveR = baseR + rOffset;
      const cx = centerX + effectiveR * Math.cos(theta);
      const cy = centerY + 0.6 * effectiveR * Math.sin(theta);

      // Car orientation tangent to circle
      const tx = -Math.sin(theta);
      const ty = 0.6 * Math.cos(theta);
      const angle = Math.atan2(ty, tx);

      p.push();
      p.translate(cx, cy);
      p.rotate(angle);

      // Shadow
      p.noStroke();
      p.fill(15, 23, 42, 80);
      p.ellipse(0, 12, 32, 10);

      // Body
      const bodyColor = statusColor === "#22c55e" ? "#fb923c" :
                        statusColor === "#f97316" ? "#38bdf8" :
                        "#ef4444";

      p.fill(bodyColor);
      p.stroke(31, 41, 55);
      p.strokeWeight(1.4);
      p.rectMode(p.CENTER);
      p.rect(0, -2, 34, 16, 4);

      // Roof
      p.fill(248, 250, 252);
      p.rect(0, -6, 16, 7, 3);

      // Wheels
      p.fill(15, 23, 42);
      p.rect(-11, 4, 8, 3, 2);
      p.rect(11, 4, 8, 3, 2);

      p.pop();

      // Arrow showing radial drift tendency
      if (drift !== 0) {
        const arrowLen = 18;
        const dir = drift; // outward (+1) or inward (-1)
        const ux = Math.cos(theta);
        const uy = 0.6 * Math.sin(theta);

        const ax1 = cx;
        const ay1 = cy;
        const ax2 = cx + dir * ux * arrowLen;
        const ay2 = cy + dir * uy * arrowLen;

        p.push();
        p.stroke(statusColor);
        p.strokeWeight(2);
        p.line(ax1, ay1, ax2, ay2);
        p.fill(statusColor);
        const ang = Math.atan2(ay2 - ay1, ax2 - ax1);
        p.translate(ax2, ay2);
        p.rotate(ang);
        p.triangle(0, 0, -5, -3, -5, 3);
        p.pop();
      }

      // Radius line to center
      p.push();
      p.stroke(216, 180, 254);
      p.strokeWeight(1);
      p.line(centerX, centerY, cx, cy);
      p.noStroke();
      p.fill(216, 180, 254);
      p.textSize(9);
      p.textAlign(p.CENTER, p.BOTTOM);
      p.text("R", (centerX + cx) / 2, (centerY + cy) / 2 - 4);
      p.pop();
    }

    function drawFBDPanel() {
      const beta = (betaDeg * Math.PI) / 180;

      p.push();
      p.translate(fbdX, fbdY);

      // Panel
      p.noFill();
      p.stroke(148, 163, 253);
      p.strokeWeight(1);
      p.rect(0, 0, fbdW, fbdH, 14);

      p.fill(107, 114, 128);
      p.noStroke();
      p.textAlign(p.LEFT, p.TOP);
      p.textSize(9);
      p.text("Free Body Diagram (cross-section)", 10, 6);

      // Local origin for car
      const ox = fbdW / 2;
      const oy = fbdH / 2 + 18;

      // Road line at angle beta
      const len = 42;
      p.stroke(75, 85, 99);
      p.strokeWeight(2);
      p.push();
      p.translate(ox, oy);
      p.rotate(-beta);
      p.line(-len, 0, len, 0);
      // mini car block
      p.fill("#fb923c");
      p.rectMode(p.CENTER);
      p.rect(0, -6, 16, 8, 3);
      p.pop();

      // Forces
      // mg downward
      drawVector(ox, oy - 4, 0, 34, "#3b82f6", "mg");

      // N perpendicular to surface (angle 90° above slope)
      const nAngle = -beta + Math.PI / 2;
      drawVector(ox, oy - 4, 26 * Math.cos(nAngle), 26 * Math.sin(nAngle), "#111827", "N");

      // Friction direction based on status
      const drift = getDriftDirection();
      if (drift !== 0) {
        // Along slope: + up-slope when preventing down-slide
        const tAngle = -beta; // up-slope direction
        const dir = drift < 0 ? -1 : +1; // v>vmax => friction down-slope (dir=-1)
        drawVector(
          ox,
          oy - 4,
          22 * dir * Math.cos(tAngle),
          22 * dir * Math.sin(tAngle),
          "#22c55e",
          "fₛ"
        );
      } else {
        // Small neutral friction arrow
        const tAngle = -beta;
        drawVector(
          ox,
          oy - 4,
          14 * Math.cos(tAngle),
          14 * Math.sin(tAngle),
          "rgba(34,197,94,0.45)",
          "fₛ"
        );
      }

      p.pop();
    }

    function drawVector(x, y, dx, dy, color, label) {
      p.push();
      if (typeof color === "string" && color.startsWith("rgba")) {
        const m = color.match(/rgba\\((\\d+),(\\d+),(\\d+),([0-9.]+)\\)/);
        if (m) {
          p.stroke(parseInt(m[1]), parseInt(m[2]), parseInt(m[3]), parseFloat(m[4]) * 255);
          p.fill(parseInt(m[1]), parseInt(m[2]), parseInt(m[3]), parseFloat(m[4]) * 255);
        } else {
          p.stroke(34, 197, 94, 120);
          p.fill(34, 197, 94, 120);
        }
      } else {
        p.stroke(color);
        p.fill(color);
      }
      p.strokeWeight(1.6);
      p.line(x, y, x + dx, y + dy);

      const ang = Math.atan2(dy, dx);
      p.translate(x + dx, y + dy);
      p.rotate(ang);
      p.triangle(0, 0, -6, -3, -6, 3);

      // Label
      p.resetMatrix();
      p.noStroke();
      p.fill(color === "#111827" ? "#111827" : "#374151");
      p.textSize(8);
      p.textAlign(p.LEFT, p.CENTER);
      p.text(label, x + dx + 4, y + dy);
      p.pop();
    }

    // Keyboard interactions
    p.keyPressed = () => {
      if (p.key === " " || p.key === "Spacebar") {
        running = !running;
      } else if (p.keyCode === p.RIGHT_ARROW) {
        v = Math.min(parseFloat(vSlider.elt.max), v + 0.5);
        vSlider.value(v);
        applySpeed();
      } else if (p.keyCode === p.LEFT_ARROW) {
        v = Math.max(0, v - 0.5);
        vSlider.value(v);
        applySpeed();
      }
    };
  };

  new p5(sketch);
</script>
</body>
</html>