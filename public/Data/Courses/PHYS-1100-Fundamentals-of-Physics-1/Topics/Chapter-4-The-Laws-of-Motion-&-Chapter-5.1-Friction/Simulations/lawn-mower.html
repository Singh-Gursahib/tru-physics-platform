<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PHYS1100 | Banked Curve with Friction: Safe Speed Range</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* --- Custom Colors and Variables (Retained from original design) --- */
    :root {
      --teal-main: #0f766e;
      --teal-soft: #14b8a6;
      --bg-soft: #f1f5f9;
      --bg-card: #ffffff;
      --slate-soft: #6b7280;
      --slate-deep: #0f172a;
      --accent-red: #ef4444;
      --accent-amber: #f59e0b;
      --accent-emerald: #22c55e;
      --road-gray: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, -sans-serif;
      background:
        radial-gradient(circle at top left, #eff6ff 0, #e0f7f5 26%, #f9fafb 68%, #eef2ff 100%);
      color: var(--slate-deep);
      overflow: hidden;
    }

    .layout-root {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: stretch;
      gap: 1.5rem;
      padding: 1.5rem;
      width: 100vw;
      height: 100vh;
    }

    /* --- LEFT PANEL STYLING --- */
    .teal-panel {
      width: 340px;
      max-width: 360px;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.14), transparent 70%),
        linear-gradient(
          180deg,
          rgba(240, 253, 250, 1),
          rgba(224, 242, 254, 1)
        );
      border-radius: 1.2rem;
      padding: 1.1rem 1.25rem 0.9rem;
      box-shadow:
        0 16px 34px rgba(15, 23, 42, 0.16),
        0 0 22px rgba(148, 163, 253, 0.18);
      border: 1px solid rgba(148, 163, 253, 0.16);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
      position: relative;
    }

    .teal-panel::-webkit-scrollbar {
      width: 6px;
    }
    .teal-panel::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 253, 0.55);
      border-radius: 999px;
    }

    .panel-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 118, 110, 0.24);
      background: rgba(240, 253, 250, 0.98);
      font-size: 0.63rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--teal-main);
    }

    .panel-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
    }

    .panel-title {
      font-size: 1.14rem;
      font-weight: 700;
      color: #064e3b;
      letter-spacing: 0.01em;
      margin-top: 0.1rem;
    }

    .panel-subtitle {
      font-size: 0.74rem;
      color: #065f46;
      line-height: 1.4;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.35rem;
      margin-top: 0.1rem;
    }

    .info-card {
      padding: 0.35rem 0.5rem;
      border-radius: 0.65rem;
      background: rgba(248, 250, 252, 0.98);
      border: 1px solid rgba(148, 163, 253, 0.18);
      display: flex;
      flex-direction: column;
      gap: 0.06rem;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.03);
      font-size: 0.6rem;
    }

    .info-label {
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .info-value {
      font-size: 0.84rem;
      font-weight: 600;
      color: #111827;
    }

    .info-sub {
      font-size: 0.6rem;
      color: #9ca3af;
    }

    .equations-block {
      margin-top: 0.16rem;
      padding: 0.42rem 0.55rem;
      border-radius: 0.75rem;
      background: rgba(248, 250, 252, 0.98);
      border: 1px solid rgba(148, 163, 253, 0.26);
      display: flex;
      flex-direction: column;
      gap: 0.16rem;
      font-size: 0.66rem;
      color: #065f46;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.04);
    }

    .equations-block code {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas;
      font-size: 0.63rem;
      padding: 0.02rem 0.22rem;
      border-radius: 0.25rem;
      background: #ecfeff;
      color: #0f766e;
    }

    .highlight-box {
      padding: 0.22rem 0.32rem;
      border-radius: 0.45rem;
      background: rgba(22, 163, 74, 0.04);
      border-left: 2px solid rgba(22, 163, 74, 0.9);
    }

    .slider-block {
      margin-top: 0.16rem;
      padding: 0.35rem 0.5rem;
      border-radius: 0.75rem;
      background: rgba(248, 250, 252, 0.98);
      border: 1px solid rgba(148, 163, 253, 0.22);
      display: flex;
      flex-direction: column;
      gap: 0.22rem;
      font-size: 0.64rem;
    }

    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.35rem;
    }

    .slider-label-main {
      font-size: 0.7rem;
      font-weight: 600;
      color: #0f172a;
    }

    .slider-label-sub {
      font-size: 0.58rem;
      color: #6b7280;
    }

    .slider-value {
      font-size: 0.7rem;
      font-weight: 600;
      color: #0f766e;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(229, 231, 235, 1);
      outline: none;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 253, 0.18);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle, #14b8a6, #0f766e);
      box-shadow:
        0 0 0 2px #ecfeff,
        0 2px 8px rgba(15, 23, 42, 0.22);
      transition: all 0.18s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.06) translateY(-0.5px);
      box-shadow:
        0 0 0 2px #e0f2fe,
        0 4px 14px rgba(15, 23, 42, 0.32);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.3rem;
    }

    .primary-btn,
    .ghost-btn,
    .outline-pill {
      border-radius: 999px;
      font-size: 0.67rem;
      padding: 0.22rem 0.7rem;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.18s ease;
      white-space: nowrap;
    }

    .primary-btn {
      background: linear-gradient(to right, #14b8a6, #0f766e);
      color: #ecfeff;
      font-weight: 600;
      box-shadow: 0 4px 14px rgba(15, 118, 110, 0.32);
    }

    .primary-btn:hover {
      box-shadow: 0 6px 18px rgba(15, 118, 110, 0.4);
      transform: translateY(-1px);
    }

    .ghost-btn {
      background: rgba(239, 246, 255, 0.98);
      color: #0f766e;
      border: 1px solid rgba(148, 163, 253, 0.6);
      font-weight: 500;
    }

    .ghost-btn:hover {
      background: #eff6ff;
      box-shadow: 0 3px 9px rgba(148, 163, 253, 0.3);
    }

    .outline-pill {
      background: transparent;
      color: #6b7280;
      border: 1px dashed rgba(148, 163, 253, 0.85);
      padding-inline: 0.5rem;
    }

    .outline-pill span.key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(148, 163, 253, 0.9);
      font-size: 0.55rem;
      color: #4b5563;
      margin-right: 0.16rem;
    }

    /* --- RIGHT SIDE STYLING --- */
    .sim-container {
      flex: 1;
      min-width: 820px;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .sim-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .sim-title-block {
      display: flex;
      flex-direction: column;
      gap: 0.08rem;
    }

    .sim-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: #0f172a;
    }

    .sim-subtitle {
      font-size: 0.74rem;
      color: #6b7280;
    }

    .sim-legend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.66rem;
      color: #6b7280;
      flex-wrap: wrap;
    }

    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      margin-right: 0.2rem;
    }

    .canvas-shell {
      background:
        radial-gradient(circle at top, #eff6ff, #ffffff 60%);
      border-radius: 1.1rem;
      padding: 0.7rem 0.9rem 0.6rem;
      box-shadow:
        0 14px 30px rgba(148, 163, 253, 0.18),
        0 0 22px rgba(148, 163, 253, 0.12);
      border: 1px solid rgba(148, 163, 253, 0.24);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .canvas-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.64rem;
      color: #6b7280;
      flex-wrap: wrap;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .pill-soft {
      padding: 0.16rem 0.55rem;
      border-radius: 999px;
      background: rgba(239, 246, 255, 0.98);
      border: 1px solid rgba(148, 163, 253, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      font-size: 0.6rem;
      color: #6b7280;
    }

    #p5-root {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 500px; /* Ensure canvas space */
    }

    @media (max-width: 1100px) {
      body {
        overflow-y: auto;
      }
      .layout-root {
        flex-direction: column;
        height: auto;
      }
      .teal-panel {
        width: 100%;
        max-width: 900px;
        max-height: 380px;
      }
      .sim-container {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="layout-root">
  <!-- LEFT: Physics controls + explanation -->
  <aside class="teal-panel">
    <div class="panel-pill">
      <span class="dot"></span>
      PHYS1100 · Banked Curve Analysis
    </div>
    <div class="panel-title">Banked Curve with Friction: Safe Speed Range</div>
    <div class="panel-subtitle">
      Explore a car on a frictional banked curve. Adjust angle β, friction coefficients (μₛ, μₖ),
      radius R, and mass m. The simulation shows the range of safe speeds [v_min, v_max] and visualizes the
      Free Body Diagram (FBD).
    </div>

    <!-- Given/default values -->
    <div class="info-grid">
      <div class="info-card">
        <div class="info-label">Gravity</div>
        <div class="info-value">g = 9.81 m/s²</div>
        <div class="info-sub">Used in calculations</div>
      </div>
      <div class="info-card">
        <div class="info-label">Road Half Width</div>
        <div class="info-value">w/2 = 5 m</div>
        <div class="info-sub">Used for slip limit</div>
      </div>
    </div>

    <!-- Equations summary -->
    <div class="equations-block">
      <div><strong>Key Equations (Static Friction μₛ used for limits):</strong></div>
      <div class="highlight-box">
        Max speed (slide <strong>up</strong>):
        <div><code>v_max² = Rg (sinβ + μₛ cosβ) / (cosβ - μₛ sinβ)</code></div>
      </div>
      <div class="highlight-box">
        Min speed (slide <strong>down</strong>):
        <div><code>v_min² = Rg (sinβ - μₛ cosβ) / (cosβ + μₛ sinβ)</code></div>
      </div>
    </div>

    <!-- Sliders -->
    <div class="slider-block">
      <div class="slider-label-row">
        <div>
          <div class="slider-label-main">Bank angle β</div>
          <div class="slider-label-sub">Tilt of the roadway (degrees)</div>
        </div>
        <div class="slider-value" id="beta-value">25°</div>
      </div>
      <input id="betaSlider" type="range" min="0" max="60" step="1" value="25" />
    </div>

    <div class="slider-block">
      <div class="slider-label-row">
        <div>
          <div class="slider-label-main">Curve Radius R</div>
          <div class="slider-label-sub">Tighter curve ⇒ stronger centripetal demand</div>
        </div>
        <div class="slider-value" id="r-value">50 m</div>
      </div>
      <input id="rSlider" type="range" min="20" max="200" step="1" value="50" />
    </div>

    <div class="slider-block">
      <div class="slider-label-row">
        <div>
          <div class="slider-label-main">Static Friction μₛ</div>
          <div class="slider-label-sub">Friction for non-slipping range</div>
        </div>
        <div class="slider-value" id="mus-value">0.30</div>
      </div>
      <input id="musSlider" type="range" min="0" max="1" step="0.01" value="0.30" />
    </div>

    <div class="slider-block">
      <div class="slider-label-row">
        <div>
          <div class="slider-label-main">Kinetic Friction μₖ</div>
          <div class="slider-label-sub">Friction when car is sliding (μₖ ≤ μₛ)</div>
        </div>
        <div class="slider-value" id="muk-value">0.25</div>
      </div>
      <input id="mukSlider" type="range" min="0" max="1" step="0.01" value="0.25" />
    </div>

    <div class="slider-block">
      <div class="slider-label-row">
        <div>
          <div class="slider-label-main">Car Speed v</div>
          <div class="slider-label-sub">Test speed against safe range</div>
        </div>
        <div class="slider-value" id="v-value">15.0 m/s</div>
      </div>
      <input id="vSlider" type="range" min="0" max="40" step="0.1" value="15" />
    </div>
    
    <div class="slider-block">
        <div class="slider-label-row">
          <div>
            <div class="slider-label-main">Car Mass m</div>
            <div class="slider-label-sub">Affects dynamic simulation (but not v_min/v_max)</div>
          </div>
          <div class="slider-value" id="m-value">1200 kg</div>
        </div>
        <input id="mSlider" type="range" min="500" max="2000" step="10" value="1200" />
      </div>

    <!-- Controls -->
    <div class="btn-row">
      <button id="playPauseButton" class="primary-btn">
        Pause
      </button>
      <button id="fbdToggleButton" class="ghost-btn">
        Toggle FBD
      </button>
      <button id="snapSafeBtn" class="ghost-btn">
        Set v to Mid-Range
      </button>
    </div>
    <div class="btn-row">
      <div class="outline-pill">
        <span class="key">Space</span> Toggle car motion
      </div>
      <div class="outline-pill">
        <span class="key">F</span> Toggle FBD
      </div>
    </div>
  </aside>

  <!-- RIGHT: Visual + FBD -->
  <section class="sim-container">
    <div class="sim-header">
      <div class="sim-title-block">
        <div class="sim-title">Banked Curve Top-Down View & Free Body Diagram</div>
        <div class="sim-subtitle">
          The top-down view shows the car's motion and radial slip. The FBD illustrates the forces
          acting on the car.
        </div>
      </div>
      <div class="sim-legend">
        <span class="flex items-center">
          <span class="legend-dot" style="background:rgb(200, 0, 0);"></span> mg (weight)
        </span>
        <span class="flex items-center">
          <span class="legend-dot" style="background:rgb(0, 150, 0);"></span> N (normal)
        </span>
        <span class="flex items-center">
          <span class="legend-dot" style="background:rgb(0, 0, 200);"></span> f (friction)
        </span>
        <span class="flex items-center">
          <span class="legend-dot" style="background:#22c55e;"></span> No Slip
        </span>
        <span class="flex items-center">
          <span class="legend-dot" style="background:#f97316;"></span> Slide Down
        </span>
        <span class="flex items-center">
          <span class="legend-dot" style="background:#ef4444;"></span> Slide Up
        </span>
      </div>
    </div>

    <div class="canvas-shell">
      <div class="canvas-toolbar">
        <div class="toolbar-left">
          <div class="pill-soft">
            β =
            <span id="beta-label" class="font-mono text-teal-700">25°</span>
          </div>
          <div class="pill-soft">
            R =
            <span id="R-label" class="font-mono text-slate-700">50</span> m
          </div>
          <div class="pill-soft">
            μₛ =
            <span id="mus-label" class="font-mono text-teal-700">0.30</span>
          </div>
          <div class="pill-soft">
            v_min =
            <span id="vmin-label" class="font-mono text-sky-700">?</span> m/s
          </div>
          <div class="pill-soft">
            v_max =
            <span id="vmax-label" class="font-mono text-sky-700">?</span> m/s
          </div>
        </div>
        <div class="toolbar-right">
          <div class="pill-soft">
            Current v =
            <span id="v-label-top" class="font-mono">15.0</span> m/s
            <span id="status-label" class="font-semibold text-emerald-600">(No Slip)</span>
          </div>
        </div>
      </div>
      <div id="p5-root"></div>
    </div>
  </section>
</div>

<script>
  const sketch = (p) => {
    // UI Elements
    let betaSlider, rSlider, musSlider, mukSlider, mSlider, vSlider;
    let betaValSpan, rValSpan, musValSpan, mukValSpan, mValSpan, vValSpan;
    let betaLabel, RLabel, musLabel, vLabelTop;
    let vminLabel, vmaxLabel, statusLabel;
    let playPauseButton, fbdToggleButton, snapSafeBtn;

    // State
    let isPlaying = true;
    let showFBD = true;
    const CANVAS_W = 800;
    const CANVAS_H = 600;

    // Physics Constants and Variables
    const g = 9.81;
    const ROAD_HALF_WIDTH_M = 5; // Physical half-width of the road in meters
    let beta, R, mu_s, mu_k, m, v;
    let carAngle = 0; // Angle on the circular track (degrees)
    let slipPosition = 0; // Radial displacement on bank (m), >0 is up/outward
    let slipVelocity = 0; // Radial velocity on bank (m/s)

    p.setup = function() {
      const canvas = p.createCanvas(CANVAS_W, CANVAS_H);
      canvas.parent("p5-root");
      p.angleMode(p.DEGREES);
      p.frameRate(60);

      // --- Link UI elements (Sidebar) ---
      betaSlider = p.select('#betaSlider');
      rSlider = p.select('#rSlider');
      musSlider = p.select('#musSlider');
      mukSlider = p.select('#mukSlider');
      mSlider = p.select('#mSlider');
      vSlider = p.select('#vSlider');

      betaValSpan = p.select('#beta-value');
      rValSpan = p.select('#r-value');
      musValSpan = p.select('#mus-value');
      mukValSpan = p.select('#muk-value');
      mValSpan = p.select('#m-value');
      vValSpan = p.select('#v-value');

      playPauseButton = p.select('#playPauseButton');
      fbdToggleButton = p.select('#fbdToggleButton');
      snapSafeBtn = p.select('#snapSafeBtn');

      // --- Link UI elements (Toolbar) ---
      betaLabel = p.select("#beta-label");
      RLabel = p.select("#R-label");
      musLabel = p.select("#mus-label");
      vLabelTop = p.select("#v-label-top");
      vminLabel = p.select("#vmin-label");
      vmaxLabel = p.select("#vmax-label");
      statusLabel = p.select("#status-label");

      // --- Event Handlers ---
      betaSlider.input(onParameterChange);
      rSlider.input(onParameterChange);
      musSlider.input(onParameterChange);
      mukSlider.input(onParameterChange);
      mSlider.input(onParameterChange);
      vSlider.input(onSpeedChange);

      playPauseButton.mousePressed(togglePlayPause);
      fbdToggleButton.mousePressed(toggleFBD);
      snapSafeBtn.mousePressed(setSafeMidSpeed);

      // Enforce mu_s >= mu_k constraint
      musSlider.input(handleFrictionConstraint);
      mukSlider.input(handleFrictionConstraint);

      // Initial update
      updateParameters();
    };

    function handleFrictionConstraint() {
        const current_mus = parseFloat(musSlider.value());
        const current_muk = parseFloat(mukSlider.value());
        if (current_muk > current_mus) {
            mukSlider.value(current_mus);
        }
        updateParameters();
    }

    function togglePlayPause() {
        isPlaying = !isPlaying;
        playPauseButton.html(isPlaying ? 'Pause' : 'Play');
    }

    function toggleFBD() {
        showFBD = !showFBD;
        fbdToggleButton.html(showFBD ? 'Hide FBD' : 'Show FBD');
    }
    
    function setSafeMidSpeed() {
        const physics = calculatePhysics();
        let midV = 0;

        if (physics.v_max === Infinity && physics.v_min > 0) {
            midV = physics.v_min + 5; // A little above v_min
        } else if (physics.v_min === 0 && physics.v_max !== Infinity) {
            midV = physics.v_max * 0.5; // Half of v_max
        } else if (physics.v_max !== Infinity && physics.v_min !== 0 && physics.v_max > physics.v_min) {
            midV = (physics.v_min + physics.v_max) / 2;
        } else {
            midV = 15; // Default if limits are weird
        }

        v = Math.min(Math.max(0, midV), parseFloat(vSlider.elt.max));
        vSlider.value(v);
        onSpeedChange();
    }


    function onParameterChange() {
        updateParameters();
    }

    function onSpeedChange() {
        v = parseFloat(vSlider.value());
        updateSpeedDisplays();
    }

    function updateParameters() {
        beta = parseFloat(betaSlider.value());
        R = parseFloat(rSlider.value());
        mu_s = parseFloat(musSlider.value());
        mu_k = parseFloat(mukSlider.value());
        m = parseFloat(mSlider.value());
        v = parseFloat(vSlider.value());

        // Update sidebar values
        betaValSpan.html(`${beta.toFixed(0)}°`);
        rValSpan.html(`${R.toFixed(0)} m`);
        musValSpan.html(mu_s.toFixed(2));
        mukValSpan.html(mu_k.toFixed(2));
        mValSpan.html(`${m.toFixed(0)} kg`);
        vValSpan.html(`${v.toFixed(1)} m/s`);

        updateSpeedDisplays();
    }

    function updateSpeedDisplays() {
        const physics = calculatePhysics();
        
        // Update toolbar values
        betaLabel.html(`${beta.toFixed(0)}°`);
        RLabel.html(R.toFixed(0));
        musLabel.html(mu_s.toFixed(2));
        vLabelTop.html(v.toFixed(1));

        let v_min_text = physics.v_min.toFixed(2);
        let v_max_text = (physics.v_max === Infinity) ? 'INF' : physics.v_max.toFixed(2);
        
        vminLabel.html(v_min_text);
        vmaxLabel.html(v_max_text);
        
        let statusColor;
        if (physics.status === "No Slip") {
            statusColor = "#22c55e"; // emerald
        } else if (physics.status === "Sliding Up") {
            statusColor = "#ef4444"; // red
        } else {
            statusColor = "#f59e0b"; // amber (using amber for slide down)
        }
        
        statusLabel.html(`(${physics.status})`);
        statusLabel.elt.style.color = statusColor;
    }

    function calculatePhysics() {
        const betaRad = p.radians(beta);
        const cosB = Math.cos(betaRad);
        const sinB = Math.sin(betaRad);

        let v_min = 0, v_max = Infinity;
        
        // --- v_min calculation (uses static friction mu_s) ---
        let v_min_num = sinB - mu_s * cosB;
        if (v_min_num > 0) {
            let v_min_den = cosB + mu_s * sinB;
            if (v_min_den > 1e-9) {
                v_min = Math.sqrt(R * g * v_min_num / v_min_den);
            }
        }
        
        // --- v_max calculation (uses static friction mu_s) ---
        let v_max_den = cosB - mu_s * sinB;
        if (v_max_den > 1e-9) {
          let v_max_num = sinB + mu_s * cosB;
          v_max = Math.sqrt(R * g * v_max_num / v_max_den);
        } else if (mu_s * sinB > cosB) {
            // Unsolvable scenario (friction angle is greater than bank angle needed for centripetal force)
            v_max = Infinity; 
        } else {
            v_max = Infinity; // Denominator near zero but positive
        }
        
        // --- Determine car's status and forces ---
        let status, f, N_val, F_net_lat, a_c;
        a_c = v * v / R;
        // Normal force N = m (g cosβ + a_c sinβ)
        N_val = m * (g * cosB + a_c * sinB); 

        if (v > v_max + 1e-3) {
          status = "Sliding Up";
          // Friction is KINETIC and opposes upward slide (points down ramp)
          f = -mu_k * N_val;
        } else if (v < v_min - 1e-3) {
          status = "Sliding Down";
          // Friction is KINETIC and opposes downward slide (points up ramp)
          f = mu_k * N_val;
        } else {
          status = "No Slip";
          // Calculate required static friction (positive is up the ramp)
          // Sum F_parallel = m a_c cosβ - m g sinβ - f = 0
          // f = m (a_c cosβ - g sinβ)
          f = m * (a_c * cosB - g * sinB);
        }
        
        // Net Lateral Force (Horizontal/Radial)
        // F_net_lat = N sinβ - f cosβ
        F_net_lat = N_val * sinB + f * cosB; // Note: f is already signed (up-slope is positive)

        return { v_min, v_max, status, N: N_val, f, F_net_lat, a_c, cosB, sinB, betaRad };
    }

    function updateAnimation(physics) {
        const dt = 1 / (p.frameRate() || 60);
        
        let angular_velocity_deg = p.degrees(v / R);
        carAngle += angular_velocity_deg * dt;
        carAngle %= 360;

        let a_slip = 0;
        if (physics.status === "Sliding Up" || physics.status === "Sliding Down") {
            // Components of forces parallel to the ramp (positive is up-slope)
            // F_c_p = m a_c cosβ
            // F_g_p = -m g sinβ
            // F_f_p = f (f is already signed: -mu_k*N for slide up, +mu_k*N for slide down)
            
            let F_cent_p = m * physics.a_c * physics.cosB;
            let F_grav_p = -m * g * physics.sinB;
            let F_net_slip = F_cent_p + F_grav_p - physics.f; // physics.f is the friction value (up-slope is positive)
            a_slip = F_net_slip / m; // Slip acceleration (up-slope is positive)
        }

        slipVelocity += a_slip * dt;
        slipPosition += slipVelocity * dt;
        
        // Bounce or stop at boundaries
        if (slipPosition > ROAD_HALF_WIDTH_M) {
            slipPosition = ROAD_HALF_WIDTH_M;
            slipVelocity *= -0.5; // Dampened bounce
        } else if (slipPosition < -ROAD_HALF_WIDTH_M) {
            slipPosition = -ROAD_HALF_WIDTH_M;
            slipVelocity *= -0.5; // Dampened bounce
        }
        
        if (physics.status === "No Slip") {
            // Slowly center the car if it's in the safe range (visual centering only)
            slipPosition *= 0.95; 
            if (Math.abs(slipPosition) < 0.001) slipPosition = 0;
            slipVelocity = 0;
        }
    }

    p.draw = function() {
        p.clear();
        const physics = calculatePhysics();
        
        if (isPlaying) {
            updateAnimation(physics);
        }

        drawScene(physics);
        // HUD is integrated into the p5 canvas for status display
        drawHUD(physics);

        if (showFBD) {
            drawFBD(physics);
        }
    };
    
    // --- DRAWING FUNCTIONS ---

    function drawScene(physics) {
        p.background(240, 244, 248);

        p.push();
        p.translate(CANVAS_W / 2, CANVAS_H / 2 + 50);
        const roadWidth = 80;
        const perspective = 0.4;
        const screenR = CANVAS_W / 3.5;
        
        // Draw Road Base (Top-Down View)
        p.stroke(100); p.strokeWeight(1); p.fill(140);
        p.ellipse(0, 0, (screenR + roadWidth / 2)*2, (screenR + roadWidth / 2)*2*perspective);
        p.fill(160, 210, 80); // Center grass/interior
        p.ellipse(0, 0, (screenR - roadWidth / 2)*2, (screenR - roadWidth / 2)*2*perspective);

        // Center line (R reference)
        p.stroke(255, 220, 0); p.strokeWeight(2); p.noFill();
        p.drawingContext.setLineDash([10, 10]);
        p.ellipse(0, 0, screenR * 2, screenR * 2 * perspective);
        p.drawingContext.setLineDash([]);

        // Car Drawing
        let visualSlipOffset = p.map(slipPosition, -ROAD_HALF_WIDTH_M, ROAD_HALF_WIDTH_M, -roadWidth/2, roadWidth/2);
        let carR = screenR + visualSlipOffset;
        let carScreenX = carR * p.cos(-carAngle);
        let carScreenY = carR * p.sin(-carAngle) * perspective;
        
        p.push();
        p.translate(carScreenX, carScreenY);
        
        // Rotate car to align with the tangent of the circular path
        p.rotate(-carAngle - 90);
        
        p.stroke(0); p.strokeWeight(1.5); p.fill(40, 40, 40); // Body color
        p.rect(-20, -10, 40, 20, 5); // Body
        p.fill(148, 163, 253, 220); // Windows
        p.rect(-12, -10, 25, 5, 2);
        
        p.pop();

        p.pop();
    }

    function drawHUD(physics) {
        p.push();
        p.fill(0, 0, 0, 150);
        p.noStroke();
        p.rect(5, 5, 310, 160, 8);

        p.textFont('monospace', 14);
        p.fill(255);
        
        let v_min_text = physics.v_min.toFixed(2);
        let v_max_text = (physics.v_max === Infinity) ? 'INF' : physics.v_max.toFixed(2);

        let requiredF = m * physics.a_c * physics.cosB - m * g * physics.sinB;
        
        let hudText = [
          `Safe Range: [${v_min_text}, ${v_max_text}] m/s`,
          `Current Speed (v): ${v.toFixed(2)} m/s`,
          `---`,
          `Required a_c (v²/R): ${physics.a_c.toFixed(2)} m/s²`,
          `Required f (static): ${(requiredF/1000).toFixed(2)} kN`,
          `Actual f: ${(physics.f/1000).toFixed(2)} kN`,
          `Slip Pos: ${slipPosition.toFixed(2)} m`,
        ];

        let statusColor;
        if (physics.status === "No Slip") statusColor = p.color(100, 255, 100);
        else if (physics.status === "Sliding Up") statusColor = p.color(255, 100, 100);
        else statusColor = p.color(255, 165, 0); // Orange for slide down

        p.textAlign(p.LEFT, p.TOP);
        let yPos = 15;
        for (let i = 0; i < hudText.length; i++) {
          if (i === 1) p.fill(statusColor); else p.fill(255);
          p.text(hudText[i], 15, yPos);
          yPos += 20;
        }

        p.pop();
    }

    function drawFBD(physics) {
        p.push();
        p.fill(248, 250, 252, 220); p.stroke(148, 163, 253, 220); p.strokeWeight(1);
        p.rect(CANVAS_W - 270, 10, 260, 260, 10);

        p.translate(CANVAS_W - 135, 160);
        
        p.fill(0); p.noStroke(); p.textAlign(p.CENTER, p.CENTER);
        p.textFont('sans-serif', 12);
        p.text('Free Body Diagram (FBD)', 0, -135);
        
        let scale = 0.012; // Scaling factor for forces

        // Car block
        p.push();
        p.rotate(-physics.betaRad);
        p.stroke(50); p.strokeWeight(4); p.strokeJoin(p.ROUND);
        p.line(-80, 0, 80, 0); // Road surface
        p.stroke(0); p.strokeWeight(2); p.fill(11, 24, 39);
        p.rect(-15, -10, 30, 10); // Car cross section
        p.pop();
        
        // Center of forces
        p.translate(0, -10); // Move center point slightly up from contact point

        // 1. Weight (mg) - Red
        drawVector(0, 0, 0, m * g * scale, 'mg', p.color(200, 0, 0));
        
        // 2. Normal Force (N) - Green
        p.push();
        p.rotate(p.degrees(-physics.betaRad));
        drawVector(0, 0, 0, -physics.N * scale, 'N', p.color(0, 150, 0));
        p.pop();

        // 3. Friction Force (f) - Blue
        let frictionMagnitude = physics.f; // f is already signed (up-slope positive)
        let frictionColor = p.color(0, 0, 200);
        
        if (physics.status !== "No Slip" && Math.abs(frictionMagnitude) < 1e-3) {
            // Should not happen, but prevents invisible FBD
            frictionMagnitude = 1;
            frictionColor = p.color(0, 0, 200, 100);
        }

        p.push();
        p.rotate(p.degrees(-physics.betaRad));
        // Rotate 90 degrees more to align with the ramp surface
        p.rotate(-90);
        drawVector(0, 0, frictionMagnitude * scale, 0, 'f', frictionColor);
        p.pop();
        
        // 4. Net Centripetal Force (F_net_lat) - Black (Horizontal component)
        p.push();
        p.stroke(0); p.strokeWeight(2); p.drawingContext.setLineDash([5, 5]);
        // Centripetal direction is horizontal (positive radial)
        let radialArrowEnd = physics.F_net_lat * scale;
        
        p.line(0, 0, radialArrowEnd, 0);
        
        p.noStroke(); p.fill(0);
        p.textAlign(p.LEFT, p.CENTER);
        p.text('F_c', radialArrowEnd + 5, 0);
        p.pop();


        p.pop();
    }
    
    function drawVector(x1, y1, x2, y2, label, col) {
        p.push();
        p.stroke(col); p.fill(col); p.strokeWeight(3);
        p.line(x1, y1, x2, y2);
        
        // Arrowhead
        p.push();
        p.translate(x2, y2);
        let angle = p.atan2(y2 - y1, x2 - x1);
        p.rotate(angle);
        p.triangle(0, 0, -8, 4, -8, -4);
        p.pop();
        
        // Label
        p.noStroke();
        p.textAlign(p.CENTER, p.CENTER);
        p.text(label, x2 * 1.2, y2 * 1.2);
        p.pop();
    }

    // --- Keyboard controls ---
    p.keyPressed = () => {
        if (p.key === " " || p.key === "Spacebar") {
            togglePlayPause();
        } else if (p.key === "f" || p.key === "F") {
            toggleFBD();
        } else if (p.keyCode === p.RIGHT_ARROW) {
            v = Math.min(parseFloat(vSlider.elt.max), v + 0.5);
            vSlider.value(v);
            onSpeedChange();
        } else if (p.keyCode === p.LEFT_ARROW) {
            v = Math.max(0, v - 0.5);
            vSlider.value(v);
            onSpeedChange();
        }
    };
  };

  new p5(sketch);
</script>
</body>
</html>